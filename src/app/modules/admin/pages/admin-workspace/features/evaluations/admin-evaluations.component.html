<div class="evals-page">

    <!-- Header -->
    <div class="page-header">
        <div class="page-header__info">
            <h1 class="page-title">
                <mat-icon svgIcon="heroicons_outline:clipboard-document-list"></mat-icon>
                Evaluaciones
            </h1>
            <p class="page-subtitle">Consulta el historial de evaluaciones y resultados de cualquier usuario</p>
        </div>
        <a routerLink="/admin" class="btn-back">
            <mat-icon svgIcon="heroicons_outline:arrow-left"></mat-icon> Volver
        </a>
    </div>

    <div class="evals-layout">

        <!-- â”€â”€ LEFT: User selector â”€â”€ -->
        <aside class="user-sidebar">
            <div class="sidebar-header">
                <mat-icon svgIcon="heroicons_outline:users"></mat-icon>
                <span>Usuarios</span> @if (loadingUsers) {
                <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                }
            </div>
            <div class="sidebar-search">
                <mat-icon svgIcon="heroicons_mini:magnifying-glass"></mat-icon>
                <input [(ngModel)]="userSearch" placeholder="Buscar usuario..." />
            </div>
            <div class="user-list">
                @for (u of filteredUsers; track u.userId) {
                <div class="user-item" [class.active]="u.userId === selectedUserId" (click)="selectUser(u.userId)">
                    <div class="user-item__avatar">{{ u.fullName.charAt(0).toUpperCase() }}</div>
                    <div class="user-item__info">
                        <div class="user-item__name">{{ u.fullName }}</div>
                        <div class="user-item__email">{{ u.email }}</div>
                    </div>
                    @if (u.lastRiskLevel) {
                    <span class="risk-dot" [class]="'risk-dot--' + u.lastRiskLevel.toLowerCase()"></span> }
                </div>
                } @empty {
                <div class="empty-list">Sin resultados</div>
                }
            </div>
        </aside>

        <!-- â”€â”€ RIGHT: Evaluations / Results â”€â”€ -->
        <main class="evals-main">

            @if (!selectedUserId) {
            <div class="welcome-state">
                <mat-icon svgIcon="heroicons_outline:clipboard-document-list"></mat-icon>
                <h3>Selecciona un usuario</h3>
                <p>Elige un usuario de la lista para ver su historial de evaluaciones y resultados.</p>
            </div>
            } @else {

            <!-- User summary bar -->
            <div class="user-bar">
                <div class="user-bar__avatar">{{ selectedUserName().charAt(0).toUpperCase() }}</div>
                <div class="user-bar__info">
                    <div class="user-bar__name">{{ selectedUserName() }}</div>
                    <div class="user-bar__counts">
                        <span>ðŸ“‹ {{ evaluations.length }} evaluaciones</span>
                        <span>ðŸ“Š {{ results.length }} resultados</span>
                    </div>
                </div>
                <div class="view-tabs">
                    <button class="view-tab" [class.active]="activeView === 'evaluations'" (click)="activeView = 'evaluations'">Evaluaciones</button>
                    <button class="view-tab" [class.active]="activeView === 'results'" (click)="activeView = 'results'">Resultados</button>
                </div>
            </div>

            <!-- Detail Panel (if open) -->
            @if (evaluationDetail) {
            <div class="detail-panel">
                <div class="detail-panel__header">
                    <h4>Detalle de EvaluaciÃ³n #{{ selectedEvaluationId }}</h4>
                    <button class="btn-close" (click)="closeDetail()">
                <mat-icon svgIcon="heroicons_mini:x-mark"></mat-icon>
              </button>
                </div>
                @if (loadingDetail) {
                <div class="loading-inline">
                    <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
                </div>
                } @else {
                <div class="responses-list">
                    @for (r of evaluationDetail.responses; track r.questionID) {
                    <div class="response-row">
                        <div class="response-row__q">{{ r.questionText }}</div>
                        <div class="response-row__v">Valor: <strong>{{ r.selectedValue }}</strong></div>
                    </div>
                    } @empty {
                    <div class="empty-msg">No hay respuestas registradas para esta evaluaciÃ³n.</div>
                    }
                </div>
                }
            </div>
            } @if (selectedResult) {
            <div class="detail-panel">
                <div class="detail-panel__header">
                    <h4>Resultado #{{ selectedResultId }} â€” {{ selectedResult.moduleName }}</h4>
                    <button class="btn-close" (click)="closeDetail()">
                <mat-icon svgIcon="heroicons_mini:x-mark"></mat-icon>
              </button>
                </div>
                @if (loadingDetail) {
                <div class="loading-inline">
                    <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
                </div>
                } @else {
                <div class="result-summary">
                    <div class="result-kpi">
                        <div class="result-kpi__label">Puntaje total</div>
                        <div class="result-kpi__value">{{ selectedResult.totalScore ?? '-' }}</div>
                    </div>
                    <div class="result-kpi">
                        <div class="result-kpi__label">Nivel de riesgo</div>
                        <div class="result-kpi__value">
                            <span class="badge" [class]="riskColor(selectedResult.riskLevel)">
                      {{ selectedResult.riskLevel || 'N/A' }}
                    </span>
                        </div>
                    </div>
                    <div class="result-kpi">
                        <div class="result-kpi__label">Completado</div>
                        <div class="result-kpi__value">{{ selectedResult.completedAt | date:'dd/MM/yyyy HH:mm' }}</div>
                    </div>
                </div>

                @if (selectedResult.instrumentResults && selectedResult.instrumentResults.length > 0) {
                <h5 class="instruments-title">Por instrumento</h5>
                <table class="instruments-table">
                    <thead>
                        <tr>
                            <th>Instrumento</th>
                            <th>Puntaje</th>
                            <th>Riesgo</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (ir of selectedResult.instrumentResults; track ir.instrumentID) {
                        <tr>
                            <td>{{ ir.instrumentName }}</td>
                            <td>{{ ir.score }}</td>
                            <td><span class="badge" [class]="riskColor(ir.riskLevel)">{{ ir.riskLevel || '-' }}</span></td>
                        </tr>
                        }
                    </tbody>
                </table>
                } }
            </div>
            }

            <!-- Evaluations Tab -->
            @if (activeView === 'evaluations') {
            <div class="content-section">
                @if (loadingEvals) {
                <div class="loading-inline">
                    <mat-progress-spinner mode="indeterminate" diameter="28"></mat-progress-spinner>
                    <span>Cargando evaluaciones...</span>
                </div>
                } @else if (evaluations.length === 0) {
                <div class="empty-state">
                    <mat-icon svgIcon="heroicons_outline:clipboard-document-list"></mat-icon>
                    <p>Este usuario no tiene evaluaciones registradas.</p>
                </div>
                } @else {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>MÃ³dulo</th>
                            <th>Estado</th>
                            <th>PerÃ­odo</th>
                            <th>Iniciada</th>
                            <th>Completada</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (e of evaluations; track e.evaluationID) {
                        <tr>
                            <td class="td-id">{{ e.evaluationID }}</td>
                            <td class="td-name">{{ e.moduleName || '-' }}</td>
                            <td><span class="badge" [class]="statusColor(e.status)">{{ e.status }}</span></td>
                            <td>{{ e.period || '-' }}</td>
                            <td>{{ e.startedAt | date:'dd/MM/yy HH:mm' }}</td>
                            <td>{{ e.completedAt | date:'dd/MM/yy HH:mm' }}</td>
                            <td class="td-actions">
                                @if (e.status === 'COMPLETED') {
                                <button class="btn-sm" (click)="viewDetail(e.evaluationID!)">
                            <mat-icon svgIcon="heroicons_mini:eye"></mat-icon> Respuestas
                          </button> }
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
                }
            </div>
            }

            <!-- Results Tab -->
            @if (activeView === 'results') {
            <div class="content-section">
                @if (loadingResults) {
                <div class="loading-inline">
                    <mat-progress-spinner mode="indeterminate" diameter="28"></mat-progress-spinner>
                    <span>Cargando resultados...</span>
                </div>
                } @else if (results.length === 0) {
                <div class="empty-state">
                    <mat-icon svgIcon="heroicons_outline:chart-bar"></mat-icon>
                    <p>Este usuario no tiene resultados registrados.</p>
                </div>
                } @else {
                <div class="results-grid">
                    @for (r of results; track (r.evaluationResultID ?? r.resultID)) {
                    <div class="result-card" (click)="viewResult(r)">
                        <div class="result-card__header">
                            <span class="result-card__module">{{ r.moduleName || 'MÃ³dulo' }}</span>
                            <span class="badge" [class]="riskColor(r.riskLevel)">{{ r.riskLevel || 'N/A' }}</span>
                        </div>
                        <div class="result-card__score">
                            <span class="score-value">{{ r.totalScore ?? 0 }}</span>
                            <span class="score-label">puntos</span>
                        </div>
                        <div class="result-card__date">{{ r.completedAt | date:'dd/MM/yyyy HH:mm' }}</div>
                        <div class="result-card__cta">Ver detalle â†’</div>
                    </div>
                    }
                </div>
                }
            </div>
            } }
        </main>
    </div>
</div>