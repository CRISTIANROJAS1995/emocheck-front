<section class="admin-page-wrapper">
    <!-- Header -->
    <header class="admin-page-header">
        <div class="admin-page-header__left">
            <div class="admin-page-header__badge">MODULOS Y EVALUACIONES</div>
            @if (viewMode === 'list') {
            <h1>Módulos de Evaluación</h1>
            <p>Gestiona los módulos del sistema de evaluación.</p>
            } @else {
            <h1>{{ selectedModule?.module?.name ?? 'Módulo' }}</h1>
            <p>{{ selectedModule?.module?.description ?? '' }}</p>
            }
        </div>
        <div class="admin-page-header__actions">
            @if (viewMode === 'detail') {
            <button class="btn btn--outline btn--sm" (click)="backToList()">
                <mat-icon>arrow_back</mat-icon> Volver a Módulos
            </button> }
            <a routerLink="/admin" class="btn btn--outline btn--sm">
                <mat-icon>arrow_back</mat-icon> Admin
            </a>
        </div>
    </header>

    <!-- KPIs -->
    @if (viewMode === 'list') {
    <div class="kpi-row">
        <div class="kpi-card kpi-card--indigo">
            <div class="kpi-card__icon">
                <mat-icon>view_module</mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ modules.length }}</span>
                <span class="kpi-card__label">Total Módulos</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--emerald">
            <div class="kpi-card__icon">
                <mat-icon>check_circle</mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ activeCount }}</span>
                <span class="kpi-card__label">Activos</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--amber">
            <div class="kpi-card__icon">
                <mat-icon>cancel</mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ modules.length - activeCount }}</span>
                <span class="kpi-card__label">Inactivos</span>
            </div>
        </div>
    </div>
    }

    <!-- Module Detail KPIs -->
    @if (viewMode === 'detail' && selectedModule) {
    <div class="kpi-row">
        <div class="kpi-card kpi-card--sky">
            <div class="kpi-card__icon">
                <mat-icon>quiz</mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ totalQuestions }}</span>
                <span class="kpi-card__label">Preguntas</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--indigo">
            <div class="kpi-card__icon">
                <mat-icon>speed</mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ selectedModule.module?.maxScore ?? 0 }}</span>
                <span class="kpi-card__label">Puntaje Máximo</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--emerald">
            <div class="kpi-card__icon">
                <mat-icon>{{ selectedModule.module?.isActive ? 'check_circle' : 'cancel' }}
                </mat-icon>
            </div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ selectedModule.module?.isActive ? 'Sí' : 'No' }}</span>
                <span class="kpi-card__label">Activo</span>
            </div>
        </div>
    </div>
    }

    <!-- ═══════════ CREATE MODULE FORM ═══════════ -->
    @if (viewMode === 'list' && showCreateModule) {
    <div class="editor-panel">
        <h3>
            <mat-icon>add_circle</mat-icon> Crear Nuevo Módulo</h3>
        <div class="editor-panel__grid">
            <label class="editor-panel__field">
                <span>Código único *</span>
                <input [(ngModel)]="moduleForm.code" placeholder="Ej: MENTAL_HEALTH" />
            </label>
            <label class="editor-panel__field">
                <span>Nombre *</span>
                <input [(ngModel)]="moduleForm.name" placeholder="Nombre del módulo" />
            </label>
            <label class="editor-panel__field editor-panel__field--full">
                <span>Descripción</span>
                <textarea [(ngModel)]="moduleForm.description" placeholder="Descripción del módulo..."
                    rows="2"></textarea>
            </label>
            <label class="editor-panel__field">
                <span>Puntaje Mínimo</span>
                <input type="number" [(ngModel)]="moduleForm.minScore" placeholder="0" />
            </label>
            <label class="editor-panel__field">
                <span>Puntaje Máximo</span>
                <input type="number" [(ngModel)]="moduleForm.maxScore" placeholder="100" />
            </label>
            <label class="editor-panel__field">
                <span>Tiempo Estimado (min)</span>
                <input type="number" [(ngModel)]="moduleForm.estimatedMinutes" placeholder="10" min="1" />
            </label>
            <label class="editor-panel__field">
                <span>Orden de Visualización</span>
                <input type="number" [(ngModel)]="moduleForm.displayOrder" placeholder="0" />
            </label>
            <label class="editor-panel__field">
                <span>Ícono</span>
                <input [(ngModel)]="moduleForm.iconName" placeholder="Ej: psychology" />
            </label>
            <label class="editor-panel__field">
                <span>Color (hex)</span>
                <input [(ngModel)]="moduleForm.colorHex" placeholder="#4F46E5" />
            </label>
        </div>
        <div class="editor-panel__actions">
            <button class="btn btn--ghost" (click)="showCreateModule = false">Cancelar</button>
            <button class="btn btn--primary" (click)="createModule()" [disabled]="saving">
                <mat-icon>save</mat-icon> Crear Módulo
            </button>
        </div>
    </div>
    }

    <!-- ═══════════ LIST VIEW ═══════════ -->
    @if (viewMode === 'list') {
    <!-- Filters -->
    <div class="admin-filters">
        <div class="admin-filters__group">
            <mat-icon class="admin-filters__icon">search</mat-icon>
            <input type="text" [(ngModel)]="search" placeholder="Buscar módulo por nombre..." class="admin-filters__search" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
            <span class="admin-filters__count">{{ filteredModules.length }} módulos</span>
            <button class="btn btn--primary btn--sm" (click)="showCreateModule = !showCreateModule">
                <mat-icon>{{ showCreateModule ? 'close' : 'add' }}</mat-icon>
                {{ showCreateModule ? 'Cerrar' : 'Nuevo Módulo' }}
            </button>
        </div>
    </div>

    @if (loading) {
    <div class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Cargando módulos...</span>
    </div>
    } @if (!loading) {
    <div class="admin-table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th (click)="toggleSort('moduleID')" [class]="sortClass('moduleID')">ID</th>
                    <th (click)="toggleSort('name')" [class]="sortClass('name')">Nombre</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Puntaje Máx</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @for (mod of filteredModules; track mod.moduleID) {
                <tr>
                    <td><strong>#{{ mod.moduleID }}</strong></td>
                    <td>{{ mod.name || '-' }}</td>
                    <td><span class="badge badge--info">{{ mod.code || '-' }}</span></td>
                    <td class="truncate-cell">{{ mod.description || '-' }}</td>
                    <td>{{ mod.maxScore ?? 0 }}</td>
                    <td>
                        <span [class]="mod.isActive ? 'badge badge--success' : 'badge badge--neutral'">
                            {{ mod.isActive ? 'Activo' : 'Inactivo' }}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button class="btn btn--primary btn--xs" (click)="openDetail(mod)" title="Ver completo">
                            <mat-icon>visibility</mat-icon>
                        </button>
                        <button class="btn btn--danger btn--xs" (click)="deleteModule(mod)" [disabled]="saving" title="Eliminar">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
        @if (filteredModules.length === 0) {
        <div class="empty-state">
            <mat-icon>view_module</mat-icon>
            <p>No hay módulos para mostrar.</p>
        </div>
        }
    </div>
    } }

    <!-- ═══════════ DETAIL VIEW ═══════════ -->
    @if (viewMode === 'detail') { @if (detailLoading) {
    <div class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Cargando módulo completo...</span>
    </div>
    } @if (!detailLoading && selectedModule) {

    <!-- Module info card (read mode) -->
    @if (editingModuleId === null) {
    <div class="detail-panel">
        <div class="detail-panel__header">
            <h3>Información del Módulo</h3>
            <div style="display:flex;gap:6px">
                <button class="btn btn--primary btn--xs" (click)="startEditModule()" title="Editar módulo">
                    <mat-icon>edit</mat-icon> Editar
                </button>
                <button class="btn btn--danger btn--xs" (click)="deleteModule(selectedModule!.module)" [disabled]="saving" title="Eliminar módulo">
                    <mat-icon>delete</mat-icon> Eliminar
                </button>
            </div>
        </div>
        <div class="detail-panel__grid">
            <div class="detail-panel__field">
                <label>Código</label>
                <span>{{ selectedModule.module?.code || 'No especificado' }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Nombre</label>
                <span>{{ selectedModule.module?.name }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Puntaje Mínimo</label>
                <span>{{ selectedModule.module?.minScore ?? 0 }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Puntaje Máximo</label>
                <span>{{ selectedModule.module?.maxScore ?? 0 }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Tiempo Estimado</label>
                <span>{{ selectedModule.module?.estimatedMinutes ?? 0 }} min</span>
            </div>
            <div class="detail-panel__field">
                <label>Orden</label>
                <span>{{ selectedModule.module?.displayOrder ?? 0 }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Ícono</label>
                <span>{{ selectedModule.module?.iconName || '-' }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Color</label>
                <span>{{ selectedModule.module?.colorHex || '-' }}</span>
            </div>
            <div class="detail-panel__field detail-panel__field--full">
                <label>Descripción</label>
                <span>{{ selectedModule.module?.description || 'Sin descripción' }}</span>
            </div>
        </div>
    </div>
    }

    <!-- Module info card (edit mode) -->
    @if (editingModuleId !== null) {
    <div class="editor-panel">
        <h3>
            <mat-icon>edit</mat-icon> Editar Módulo #{{ editingModuleId }}</h3>
        <div class="editor-panel__grid">
            <label class="editor-panel__field">
                <span>Código único *</span>
                <input [(ngModel)]="editModuleForm.code" placeholder="Ej: MENTAL_HEALTH" />
            </label>
            <label class="editor-panel__field">
                <span>Nombre *</span>
                <input [(ngModel)]="editModuleForm.name" placeholder="Nombre del módulo" />
            </label>
            <label class="editor-panel__field editor-panel__field--full">
                <span>Descripción</span>
                <textarea [(ngModel)]="editModuleForm.description" placeholder="Descripción..." rows="2"></textarea>
            </label>
            <label class="editor-panel__field">
                <span>Puntaje Mínimo</span>
                <input type="number" [(ngModel)]="editModuleForm.minScore" />
            </label>
            <label class="editor-panel__field">
                <span>Puntaje Máximo</span>
                <input type="number" [(ngModel)]="editModuleForm.maxScore" />
            </label>
            <label class="editor-panel__field">
                <span>Tiempo Estimado (min)</span>
                <input type="number" [(ngModel)]="editModuleForm.estimatedMinutes" min="1" />
            </label>
            <label class="editor-panel__field">
                <span>Orden</span>
                <input type="number" [(ngModel)]="editModuleForm.displayOrder" />
            </label>
            <label class="editor-panel__field">
                <span>Ícono</span>
                <input [(ngModel)]="editModuleForm.iconName" placeholder="Ej: psychology" />
            </label>
            <label class="editor-panel__field">
                <span>Color (hex)</span>
                <input [(ngModel)]="editModuleForm.colorHex" placeholder="#4F46E5" />
            </label>
        </div>
        <div class="editor-panel__actions">
            <button class="btn btn--ghost" (click)="cancelEditModule()">Cancelar</button>
            <button class="btn btn--primary" (click)="saveEditModule()" [disabled]="saving">
                <mat-icon>save</mat-icon> Guardar Cambios
            </button>
        </div>
    </div>
    }

    <!-- Instruments Section -->
    <div class="instruments-section">
        <div class="instruments-section__header">
            <h3>
                <mat-icon>library_books</mat-icon>
                Instrumentos ({{ selectedModule.instruments?.length ?? 0 }})
            </h3>
        </div>

        @if (!selectedModule.instruments || selectedModule.instruments.length === 0) {
        <div class="empty-state">
            <mat-icon>library_books</mat-icon>
            <p>Este módulo no tiene instrumentos configurados.</p>
        </div>
        } @for (inst of selectedModule.instruments; track inst.instrumentID) {
        <div class="instrument-card" [class.instrument-card--open]="isInstrumentExpanded(inst.instrumentID)">

            <!-- Instrument header (clickable accordion) -->
            <div class="instrument-card__header" (click)="toggleInstrument(inst.instrumentID)">
                <div class="instrument-card__title">
                    <mat-icon>assignment</mat-icon>
                    <strong>{{ inst.name }}</strong>
                    <span class="badge badge--info">{{ inst.code }}</span>
                    <span style="color:#64748b;font-size:12px;font-weight:400">
                        {{ inst.itemCount ?? 0 }} ítems &nbsp;·&nbsp; max {{ inst.maxScore ?? 0 }} pts
                    </span>
                </div>
                <mat-icon>{{ isInstrumentExpanded(inst.instrumentID) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>

            <!-- Instrument body (questions) -->
            @if (isInstrumentExpanded(inst.instrumentID)) {
            <div class="instrument-card__body">
                @if (inst.description) {
                <p class="instrument-card__desc">{{ inst.description }}</p>
                } @if (questionsForInstrument(inst.instrumentID).length > 0) {
                <table class="admin-table admin-table--nested">
                    <thead>
                        <tr>
                            <th style="width:42px">#</th>
                            <th>Pregunta</th>
                            <th style="width:110px">Dimensión</th>
                            <th style="width:80px">Invertida</th>
                            <th style="width:70px">Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (q of questionsForInstrument(inst.instrumentID); track q.questionID; let i = $index) {
                        <tr>
                            <td><strong>{{ q.questionNumber ?? (i + 1) }}</strong></td>
                            <td>{{ q.questionText || '-' }}</td>
                            <td>
                                <span class="badge badge--info">{{ q.dimensionCode || 'N/A' }}</span>
                            </td>
                            <td>{{ q.isReversed ? 'Sí' : 'No' }}</td>
                            <td>{{ q.options?.length ?? 0 }}</td>
                        </tr>
                        }
                    </tbody>
                </table>
                } @else {
                <p class="no-questions">No hay preguntas registradas para este instrumento.</p>
                }
            </div>
            }

        </div>
        }
    </div>

    } }
</section>