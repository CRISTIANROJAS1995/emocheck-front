<section class="admin-page-wrapper">
    <!-- Header -->
    <header class="admin-page-header">
        <div class="admin-page-header__left">
            <div class="admin-page-header__badge">CENTRO DE ALERTAS</div>
            <h1>Gestión de Alertas</h1>
            <p>Monitorea y gestiona las alertas generadas por evaluaciones emocionales.</p>
        </div>
        <a routerLink="/admin" class="btn btn--outline btn--sm">
            <mat-icon>arrow_back</mat-icon> Volver
        </a>
    </header>

    <!-- KPIs -->
    @if (stats) {
    <div class="kpi-row">
        <div class="kpi-card kpi-card--indigo">
            <div class="kpi-card__icon"><mat-icon>notifications</mat-icon></div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ stats.totalAlerts ?? 0 }}</span>
                <span class="kpi-card__label">Total Alertas</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--rose">
            <div class="kpi-card__icon"><mat-icon>error</mat-icon></div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ stats.criticalCount ?? 0 }}</span>
                <span class="kpi-card__label">Críticas</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--amber">
            <div class="kpi-card__icon"><mat-icon>schedule</mat-icon></div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ stats.pendingCount ?? 0 }}</span>
                <span class="kpi-card__label">Pendientes</span>
            </div>
        </div>
        <div class="kpi-card kpi-card--emerald">
            <div class="kpi-card__icon"><mat-icon>check_circle</mat-icon></div>
            <div class="kpi-card__body">
                <span class="kpi-card__value">{{ stats.resolvedCount ?? 0 }}</span>
                <span class="kpi-card__label">Resueltas</span>
            </div>
        </div>
    </div>
    }

    <!-- Filters -->
    <div class="admin-filters">
        <div class="admin-filters__group">
            <mat-icon class="admin-filters__icon">filter_list</mat-icon>
            <select [(ngModel)]="statusFilter" (ngModelChange)="applyFilter()">
                <option value="">Todos los estados</option>
                <option value="Pending">Pendientes</option>
                <option value="Attended">Atendidas</option>
            </select>
            <select [(ngModel)]="levelFilter" (ngModelChange)="applyFilter()">
                <option value="">Todos los niveles</option>
                <option value="Critical">Crítica</option>
                <option value="High">Alta</option>
                <option value="Medium">Media</option>
                <option value="Low">Baja</option>
            </select>
        </div>
        <span class="admin-filters__count">{{ filteredAlerts.length }} alertas</span>
    </div>

    <!-- Loading -->
    @if (loading) {
    <div class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Cargando alertas...</span>
    </div>
    }

    <!-- Data Table -->
    @if (!loading) {
    <div class="admin-table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th (click)="toggleSort('alertId')" [class]="sortClass('alertId')">ID</th>
                    <th (click)="toggleSort('alertLevel')" [class]="sortClass('alertLevel')">Nivel</th>
                    <th (click)="toggleSort('alertType')" [class]="sortClass('alertType')">Tipo</th>
                    <th (click)="toggleSort('userIdAnonymized')" [class]="sortClass('userIdAnonymized')">Usuario</th>
                    <th (click)="toggleSort('createdAt')" [class]="sortClass('createdAt')">Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @for (alert of filteredAlerts; track alert.alertId) {
                <tr [class.row--selected]="selectedAlert?.alertId === alert.alertId" (click)="selectAlert(alert)">
                    <td><strong>#{{ alert.alertId }}</strong></td>
                    <td><span [class]="severityBadgeClass(alert.alertLevel)">{{ alert.alertLevel || 'N/A' }}</span></td>
                    <td>{{ alert.alertType || '-' }}</td>
                    <td>{{ alert.userIdAnonymized || alert.userId || '-' }}</td>
                    <td>{{ alert.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td><span [class]="statusBadgeClass(alert.isAttended)">{{ alert.isAttended ? 'Atendida' :
                            'Pendiente' }}</span></td>
                    <td class="actions-cell">
                        @if (!alert.isAttended) {
                        <button class="btn btn--primary btn--xs"
                            (click)="acknowledgeAlert(alert); $event.stopPropagation()" [disabled]="saving">
                            <mat-icon>done</mat-icon> Reconocer
                        </button>
                        }
                        <button class="btn btn--outline btn--xs" (click)="selectAlert(alert); $event.stopPropagation()">
                            <mat-icon>visibility</mat-icon>
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
        @if (filteredAlerts.length === 0) {
        <div class="empty-state">
            <mat-icon>notifications_off</mat-icon>
            <p>No hay alertas para los filtros seleccionados.</p>
        </div>
        }
    </div>
    }

    <!-- Detail / Resolve Panel -->
    @if (selectedAlert; as current) {
    <div class="detail-panel">
        <div class="detail-panel__header">
            <h3>Alerta #{{ current.alertId }}</h3>
            <button class="btn btn--ghost btn--sm" (click)="selectedAlert = null">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <div class="detail-panel__grid">
            <div class="detail-panel__field">
                <label>Nivel</label>
                <span [class]="severityBadgeClass(current.alertLevel)">{{ current.alertLevel || 'N/A' }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Tipo</label>
                <span>{{ current.alertType || '-' }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Usuario</label>
                <span>{{ current.userIdAnonymized || current.userId }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Estado</label>
                <span [class]="statusBadgeClass(current.isAttended)">{{ current.isAttended ? 'Atendida' : 'Pendiente'
                    }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Fecha creación</label>
                <span>{{ current.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="detail-panel__field">
                <label>Acción tomada</label>
                <span>{{ current.actionTaken || 'Sin acción' }}</span>
            </div>
            @if (current.notes) {
            <div class="detail-panel__field detail-panel__field--full">
                <label>Notas</label>
                <span>{{ current.notes }}</span>
            </div>
            }
        </div>

        @if (!current.isAttended) {
        <div class="detail-panel__resolve">
            <h4>Asignar psicólogo</h4>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                <select [(ngModel)]="assignToUserId"
                    style="flex:1;padding:8px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px">
                    <option [ngValue]="null" disabled>-- Seleccionar psicólogo --</option>
                    @for (p of psychologists; track p.userId) {
                    <option [ngValue]="p.userId">{{ p.fullName }} ({{ p.email }})</option>
                    }
                </select>
                <button class="btn btn--primary btn--sm" [disabled]="saving || !assignToUserId" (click)="assignAlert()">
                    <mat-icon>person_add</mat-icon> Asignar
                </button>
            </div>

            <h4>Resolver alerta</h4>
            <textarea rows="3" class="resolve-textarea" [(ngModel)]="resolution"
                placeholder="Describe la resolución (opcional)..."></textarea>
            <div class="detail-panel__actions">
                <button class="btn btn--success" [disabled]="saving" (click)="resolveAlert()">
                    <mat-icon>check_circle</mat-icon> Resolver alerta
                </button>
            </div>
        </div>
        }
    </div>
    }
</section>