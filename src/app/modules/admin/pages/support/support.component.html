<div class="support-page">
    <app-background-circles></app-background-circles>

    <div class="support-shell">
        <section class="support-hero">
            <div class="support-hero__left">
                <div class="support-hero__title-row">
                    <img class="support-hero__logo" src="icons/Icon.svg" alt="" />
                    <h1 class="support-hero__title">Ayuda</h1>
                </div>
                <p class="support-hero__subtitle">Apoyo psicológico y contactos de emergencia</p>
            </div>

            <a class="support-hero__back" mat-button [routerLink]="['/home']">
                <span class="support-hero__back-content">
                    <mat-icon class="support-hero__back-icon" svgIcon="heroicons_outline:arrow-left"></mat-icon>
                    <span class="support-hero__back-text">Volver</span>
                </span>
            </a>
        </section>

        <div class="support-container">
            <div class="support-surface">

                <!-- Loading -->
                <div class="support-loading" *ngIf="loading">
                    <mat-progress-spinner diameter="28" mode="indeterminate"></mat-progress-spinner>
                </div>

                <!-- Error global -->
                <div class="support-callout support-callout--danger" *ngIf="!loading && error">
                    <div class="support-callout__icon">
                        <mat-icon svgIcon="heroicons_outline:exclamation-triangle"></mat-icon>
                    </div>
                    <div class="support-callout__body">
                        <div class="support-callout__title">No pudimos cargar la información</div>
                        <div class="support-callout__text">{{ error }}</div>
                    </div>
                </div>

                <!-- Éxito -->
                <div class="support-callout support-callout--success" *ngIf="successMessage">
                    <div class="support-callout__icon">
                        <mat-icon svgIcon="heroicons_outline:check-circle"></mat-icon>
                    </div>
                    <div class="support-callout__body">
                        <div class="support-callout__text">{{ successMessage }}</div>
                    </div>
                </div>

                <div class="support-grid" *ngIf="!loading">
                    <!-- Emergencias -->
                    <section class="support-card support-card--emergency">
                        <div class="support-card__header">
                            <div class="support-card__title">
                                <span class="support-card__glyph" aria-hidden="true">
                                    <mat-icon svgIcon="heroicons_outline:exclamation-triangle"></mat-icon>
                                </span>
                                <span>Emergencias</span>
                            </div>
                            <button mat-button class="support-card__cta" type="button" (click)="call123()">
                                Línea 123
                            </button>
                        </div>

                        <div class="support-card__body" *ngIf="emergencyContacts?.length; else noEmergency">
                            <div class="support-contact" *ngFor="let c of emergencyContacts">
                                <div class="support-contact__name">{{ c.fullName }}</div>
                                <div class="support-contact__meta">
                                    <span *ngIf="c.phone">Tel: {{ c.phone }}</span>
                                    <span *ngIf="c.emergencyLine"> • Línea: {{ c.emergencyLine }}</span>
                                    <span *ngIf="c.availability"> • {{ c.availability }}</span>
                                </div>
                            </div>
                        </div>

                        <ng-template #noEmergency>
                            <div class="support-empty">
                                <div class="support-empty__icon" aria-hidden="true">
                                    <mat-icon svgIcon="heroicons_outline:phone"></mat-icon>
                                </div>
                                <div class="support-empty__content">
                                    <div class="support-empty__title">Sin contactos disponibles</div>
                                    <div class="support-empty__text">Si necesitas ayuda urgente, usa la Línea 123.</div>
                                </div>
                            </div>
                        </ng-template>

                        <div class="support-card__actions">
                            <button mat-button class="support-btn support-btn--danger" type="button" [disabled]="submitting" (click)="createEmergencyRequest()">
                                <mat-progress-spinner *ngIf="submitting" diameter="16" mode="indeterminate"></mat-progress-spinner>
                                Solicitar ayuda inmediata
                            </button>
                        </div>
                    </section>

                    <!-- Apoyo psicológico -->
                    <section class="support-card support-card--chat">
                        <div class="support-card__header">
                            <div class="support-card__title">
                                <span class="support-card__glyph" aria-hidden="true">
                                    <mat-icon svgIcon="heroicons_outline:chat-bubble-left-right"></mat-icon>
                                </span>
                                <span>Apoyo psicológico</span>
                            </div>
                            <button mat-button class="support-card__cta" type="button" (click)="openForm()">
                                Nueva solicitud
                            </button>
                        </div>

                        <div class="support-card__body">
                            <div class="support-empty" *ngIf="!myRequests?.length">
                                <div class="support-empty__icon" aria-hidden="true">
                                    <mat-icon svgIcon="heroicons_outline:chat-bubble-left-right"></mat-icon>
                                </div>
                                <div class="support-empty__content">
                                    <div class="support-empty__title">Aún no tienes solicitudes</div>
                                    <div class="support-empty__text">Crea una solicitud y te contactaremos pronto.</div>
                                </div>
                            </div>

                            <div class="support-request" *ngFor="let r of myRequests">
                                <div class="support-request__row">
                                    <div class="support-request__subject">{{ r.subject }}</div>
                                    <div class="support-request__status support-request__status--{{ statusTone(r.status) }}">
                                        {{ statusLabel(r.status) }}
                                    </div>
                                </div>
                                <div class="support-request__meta">
                                    {{ priorityLabel(r.priority) }} • {{ r.requestedAt | date: 'dd/MM/yyyy HH:mm' }}
                                </div>
                                <div class="support-request__meta" *ngIf="r.assignedToPsychologistName">
                                    Asignado a: <strong>{{ r.assignedToPsychologistName }}</strong>
                                    <span *ngIf="r.assignedToPsychologistPhone"> ({{ r.assignedToPsychologistPhone }})</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="support-hint" *ngIf="evaluationResultId">
                    Resultado asociado: <strong>#{{ evaluationResultId }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal formulario nueva solicitud -->
    <div class="support-modal-overlay" *ngIf="showForm" (click)="closeForm()">
        <div class="support-modal" (click)="$event.stopPropagation()">
            <div class="support-modal__header">
                <span class="support-modal__title">Nueva solicitud de apoyo</span>
                <button class="support-modal__close" type="button" (click)="closeForm()" aria-label="Cerrar">
                    <mat-icon svgIcon="heroicons_outline:x-mark"></mat-icon>
                </button>
            </div>

            <div class="support-modal__body">
                <!-- Error de formulario -->
                <div class="support-form-error" *ngIf="formError">
                    <mat-icon svgIcon="heroicons_outline:exclamation-circle"></mat-icon>
                    <span>{{ formError }}</span>
                </div>

                <div class="support-form-group">
                    <label class="support-form-label" for="formSubject">Asunto <span class="required">*</span></label>
                    <input id="formSubject" class="support-form-input" type="text" [(ngModel)]="formSubject" placeholder="Ej: Necesito orientación sobre mi evaluación" maxlength="150" />
                </div>

                <div class="support-form-group">
                    <label class="support-form-label" for="formDescription">Descripción <span class="required">*</span></label>
                    <textarea id="formDescription" class="support-form-textarea" [(ngModel)]="formDescription" placeholder="Cuéntanos brevemente cómo te sientes o qué necesitas..." rows="4" maxlength="500"></textarea>
                </div>

                <div class="support-form-group">
                    <label class="support-form-label" for="formPriority">Prioridad</label>
                    <select id="formPriority" class="support-form-select" [(ngModel)]="formPriority">
                        <option *ngFor="let p of priorityOptions" [value]="p.value">{{ p.label }}</option>
                    </select>
                </div>
            </div>

            <div class="support-modal__footer">
                <button class="support-btn support-btn--ghost" type="button" (click)="closeForm()">
                    Cancelar
                </button>
                <button class="support-btn support-btn--primary" type="button" [disabled]="submitting" (click)="submitForm()">
                    <mat-progress-spinner *ngIf="submitting" diameter="16" mode="indeterminate"></mat-progress-spinner>
                    <span>{{ submitting ? 'Enviando...' : 'Enviar solicitud' }}</span>
                </button>
            </div>
        </div>
    </div>
</div>