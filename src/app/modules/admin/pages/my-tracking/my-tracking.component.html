<div class="my-tracking-page">
    <!-- Decorative background circles (same as questionnaire screens) -->
    <app-background-circles></app-background-circles>

    <div class="my-tracking-container">
        <!-- Header banner -->
        <section class="tracking-hero">
            <div class="tracking-hero__left">
                <div class="tracking-hero__title-row">
                    <img class="tracking-hero__logo" src="icons/Icon.svg" alt="" />
                    <h1 class="tracking-hero__title">Mi Seguimiento</h1>
                </div>
                <p class="tracking-hero__subtitle">Aquí puedes ver tu evolución personal y resultados individuales</p>
            </div>

            <button class="tracking-hero__back" mat-button [routerLink]="['/home']">
                <span class="tracking-hero__back-content">
                    <mat-icon class="tracking-hero__back-icon" svgIcon="heroicons_outline:arrow-left"></mat-icon>
                    <span class="tracking-hero__back-text">Volver a mis evaluaciones</span>
                </span>
            </button>
        </section>

        <!-- Thank you card -->
        <section class="tracking-thanks">
            <div class="tracking-thanks__icon">
                <img class="tracking-thanks__icon-img" src="icons/cuidado-integral.svg" alt="" aria-hidden="true" />
            </div>

            <div class="tracking-thanks__content">
                <p class="tracking-thanks__text tracking-thanks__text--nowrap">
                    <span class="tracking-thanks__text--purple">Te agradecemos por dedicar tiempo a reconocer cómo te
                        sientes</span>
                    <span> y por ser tan honesta/o contigo misma/o.</span>
                </p>

                <p class="tracking-thanks__text tracking-thanks__text--green">
                    Cada paso de autoconocimiento fortalece tu equilibrio emocional.
                </p>

                <p class="tracking-thanks__text tracking-thanks__text--muted">
                    Si has tenido días difíciles, recuerda que dispones de herramientas y actividades para retomar la calma y
                    <br />
                    <span class="tracking-thanks__text--nowrap">reconectarte contigo.</span>
                </p>
            </div>

            <div class="tracking-thanks__sparkles">
                <span class="tracking-thanks__side-icon" aria-hidden="true"></span>
            </div>
        </section>

        <!-- Filters -->
        <section class="tracking-filters">
            <div class="tracking-filters__title">
                <mat-icon svgIcon="heroicons_outline:funnel"></mat-icon>
                <span>Filtros de Visualización</span>
            </div>

            <div class="tracking-filters__grid">
                <div class="tracking-filters__field">
                    <label class="tracking-filters__label">Período de tiempo</label>
                    <mat-form-field appearance="outline" class="tracking-filters__mat">
                        <mat-select [(value)]="selectedTimeRange">
                            @for (range of timeRanges; track range.id) {
                            <mat-option [value]="range.id">{{ range.label }}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="tracking-filters__actions">
                    <label class="tracking-filters__label">Acciones</label>
                    <button class="tracking-filters__export" mat-button (click)="exportReport()">
                        <mat-icon svgIcon="heroicons_outline:arrow-down-tray"></mat-icon>
                        Exportar Reporte
                    </button>
                </div>
            </div>
        </section>

        <!-- State + mini chart -->
        <section class="tracking-state">
            <div class="tracking-state__left">
                <div class="tracking-state__body">
                    <div class="tracking-state__bigicon" [ngClass]="'tracking-state__bigicon--' + stateCard.tone">
                        <mat-icon svgIcon="heroicons_outline:heart"></mat-icon>
                    </div>

                    <div class="tracking-state__score">
                        <div class="tracking-state__headline">
                            <span class="tracking-state__headline-icon" aria-hidden="true"></span>
                            <span>{{ stateCard.headline }}</span>
                        </div>
                        <div class="tracking-state__score-main">
                            <span class="tracking-state__score-value">{{ stateCard.scoreOutOfTen }}</span>
                            <mat-icon class="tracking-state__score-up" svgIcon="heroicons_outline:arrow-trending-up"></mat-icon>
                        </div>
                        <p class="tracking-state__desc">
                            {{ stateCard.description }}
                        </p>

                        <button class="tracking-state__cta" mat-button (click)="goToEmotionalAnalysis()">
                            <mat-icon svgIcon="heroicons_outline:heart"></mat-icon>
                            ¿Cuéntanos cómo te sientes hoy?
                        </button>
                    </div>
                </div>
            </div>

            <div class="tracking-state__right">
                <p class="tracking-state__chart-title">Seguimiento de tu estado de ánimo (Último mes)</p>

                <apx-chart class="tracking-state__chart" [series]="moodTrackingChart.series" [chart]="moodTrackingChart.chart" [xaxis]="moodTrackingChart.xaxis" [yaxis]="moodTrackingChart.yaxis" [stroke]="moodTrackingChart.stroke" [grid]="moodTrackingChart.grid" [dataLabels]="moodTrackingChart.dataLabels"
                    [markers]="moodTrackingChart.markers" [tooltip]="moodTrackingChart.tooltip" [colors]="moodTrackingChart.colors"></apx-chart>
            </div>
        </section>

        <!-- Module progress -->
        <section class="tracking-modules">
            <div class="tracking-modules__header">
                <div class="tracking-modules__title">
                    <img class="tracking-modules__title-icon" src="icons/Icon (41).svg" alt="" aria-hidden="true" />
                    <span>Tus Avances en los Diferentes Módulos</span>
                </div>
                <p class="tracking-modules__subtitle">
                    Para una mayor exactitud debes responder las pruebas necesarias para cada módulo
                </p>
            </div>

            <div class="tracking-modules__list">
                @for (m of moduleProgress; track m.id) {
                <div class="module-row">
                    <div class="module-row__icon">
                        <img class="module-row__icon-img" [src]="m.icon" alt="" aria-hidden="true" />
                    </div>

                    <div class="module-row__content">
                        <div class="module-row__top">
                            <div class="module-row__name">{{ m.title }}</div>
                            <div class="module-row__right">
                                @if (m.isCompleted && m.percent > 0) { @if (m.badgeLabel) {
                                <span class="module-row__badge" [ngClass]="'module-row__badge--' + m.badgeTone">{{
                                    m.badgeLabel }}</span> }
                                <span class="module-row__pct" [ngClass]="'module-row__pct--' + m.tone">{{ m.percent
                                    }}%</span> }
                            </div>
                        </div>
                        <div class="module-row__bar">
                            @if (m.isCompleted && m.percent > 0) {
                            <div class="module-row__bar-fill" [ngClass]="'module-row__bar-fill--' + m.tone" [style.width.%]="m.percent"></div>
                            }
                        </div>

                        <div class="module-row__status">{{ m.statusText }}</div>
                    </div>
                </div>
                }
            </div>
        </section>

        <!-- Small stats cards -->
        <section class="tracking-stats">
            <div class="stat-card stat-card--teal">
                <div class="stat-card__icon"><img class="stat-card__icon-img" src="icons/Icon (42).svg" alt="" aria-hidden="true" /></div>
                <div class="stat-card__value">{{ stats.completedCount }}/4</div>
                <div class="stat-card__label">
                    Módulos completados<br /> @if (stats.pendingCount === 0) {
                    <span class="stat-card__label-all">¡Todos completos!</span> } @else {
                    <span class="stat-card__label-all">{{ stats.pendingCount }} {{ stats.pendingCount === 1 ?
                        'pendiente' : 'pendientes' }}</span> }
                </div>
                <mat-icon class="stat-card__corner" svgIcon="heroicons_outline:calendar"></mat-icon>
            </div>

            <div class="stat-card stat-card--blue">
                <div class="stat-card__icon"><img class="stat-card__icon-img" src="icons/Icon (43).svg" alt="" aria-hidden="true" /></div>
                <div class="stat-card__value">{{ stats.averageWellbeingPercent }}%</div>
                <div class="stat-card__label">Bienestar promedio<br /><span class="stat-card__label-accent">Tu
                        puntuación general</span></div>
                <mat-icon class="stat-card__corner" svgIcon="heroicons_outline:arrow-trending-up"></mat-icon>
            </div>

            <div class="stat-card stat-card--lime">
                <div class="stat-card__icon"><img class="stat-card__icon-img" src="icons/Icon (44).svg" alt="" aria-hidden="true" /></div>
                <div class="stat-card__value">{{ vsPromedioLabel }}</div>
                <div class="stat-card__label">Comparación organizacional<br /><span class="stat-card__label-accent">{{ vsPromedioSubtitle }}</span></div>
            </div>

            <div class="stat-card stat-card--purple">
                <div class="stat-card__icon"><img class="stat-card__icon-img" src="icons/Icon (45).svg" alt="" aria-hidden="true" /></div>
                <div class="stat-card__value">{{ memberSinceLabel }}</div>
                <div class="stat-card__label">Tiempo en EmoCheck<br /><span class="stat-card__label-accent">Mejora
                        sostenida</span></div>
                <mat-icon class="stat-card__corner" svgIcon="heroicons_outline:arrow-trending-up"></mat-icon>
            </div>
        </section>

        <!-- Results by module -->
        <section class="tracking-results">
            <div class="tracking-section-title">Mis Resultados por Módulo</div>
            <div class="tracking-section-subtitle">Tus puntajes actuales en cada evaluación</div>

            <div class="tracking-results__grid">
                @for (card of moduleResults; track card.id) {
                <div class="result-card" [ngClass]="'result-card--' + card.id" [class.result-card--disabled]="!card.isCompleted" [class.result-card--good]="card.isCompleted && card.toneClass === 'good'" [class.result-card--warn]="card.isCompleted && card.toneClass === 'warn'"
                    [class.result-card--bad]="card.isCompleted && card.toneClass === 'bad'" (click)="openModuleResults(card.id)">
                    <div class="result-card__head">
                        <div class="result-card__icon">
                            <img class="result-card__icon-img" [src]="moduleIcon(card.id)" alt="" aria-hidden="true" />
                        </div>
                        <div>
                            <div class="result-card__title">{{ card.title }}</div>
                            <div class="result-card__meta">
                                @if (card.isCompleted) { {{ card.completedAt }} } @else { No completado }
                            </div>
                        </div>
                        @if (card.isCompleted) {
                        <div class="result-card__actions">
                            @if (card.toneClass !== 'disabled') {
                            <div class="result-card__status-pill" [ngClass]="'result-card__status-pill--' + card.toneClass">
                                <img class="result-card__status-pill-icon" [src]="riskPillIcon(card.toneClass)" alt="" aria-hidden="true" />
                            </div>
                            }
                            <div class="result-card__eye">
                                <mat-icon svgIcon="heroicons_outline:eye"></mat-icon>
                            </div>
                        </div>
                        }
                    </div>

                    @if (card.isCompleted) {
                    <div class="result-card__body">
                        <div class="result-card__row">
                            <span>Tu puntaje:</span>
                            <span class="result-card__pct">{{ card.scorePercent }}%</span>
                        </div>
                        <div class="result-card__bar">
                            <div class="result-card__bar-fill" [style.width.%]="card.scorePercent"></div>
                        </div>
                        <div class="result-card__footer">{{ card.riskLabel || card.riskLevel }}</div>
                    </div>
                    } @else {
                    <div class="result-card__hint">Completa esta evaluación para ver tus resultados</div>
                    }
                </div>
                }
            </div>
        </section>

        <!-- Evolution + radar comparison -->
        <section class="tracking-charts">
            <div class="chart-card">
                <div class="chart-card__title">Mi Evolución en el Tiempo</div>
                <div class="chart-card__subtitle">Progreso de tus puntajes en los últimos 6 meses</div>
                @if (hasChartData) {
                <apx-chart [series]="moodTrackingChart.series" [chart]="moodTrackingChart.chart" [colors]="moodTrackingChart.colors" [stroke]="moodTrackingChart.stroke" [dataLabels]="moodTrackingChart.dataLabels" [markers]="moodTrackingChart.markers" [grid]="moodTrackingChart.grid"
                    [xaxis]="moodTrackingChart.xaxis" [yaxis]="moodTrackingChart.yaxis" [tooltip]="moodTrackingChart.tooltip">
                </apx-chart>
                <div class="chart-card__legend">
                    <span class="lg-item lg-item--teal">Clima Org.</span>
                    <span class="lg-item lg-item--lime">Fatiga Laboral</span>
                    <span class="lg-item lg-item--orange">Riesgo Psico.</span>
                    <span class="lg-item lg-item--purple">Salud Mental</span>
                </div>
                } @else if (!loading) {
                <div class="chart-empty">
                    <span>Completa al menos una evaluación para ver tu evolución en el tiempo.</span>
                </div>
                }
            </div>

            <div class="chart-card">
                <div class="chart-card__title">Comparación con Promedio Organizacional</div>
                <div class="chart-card__subtitle">Tu desempeño vs. promedio de la organización</div>
                <apx-chart [series]="radarComparisonChart.series" [chart]="radarComparisonChart.chart" [xaxis]="radarComparisonChart.xaxis" [yaxis]="radarComparisonChart.yaxis" [stroke]="radarComparisonChart.stroke" [fill]="radarComparisonChart.fill" [markers]="radarComparisonChart.markers"
                    [dataLabels]="radarComparisonChart.dataLabels" [tooltip]="radarComparisonChart.tooltip" [colors]="radarComparisonChart.colors" [legend]="radarComparisonChart.legend" [plotOptions]="radarComparisonChart.plotOptions"></apx-chart>
            </div>
        </section>

        <!-- Follow-ups -->
        <section class="tracking-followups">
            <div class="tracking-followups__title">
                <span class="tracking-followups__title-icon" aria-hidden="true"></span>
                <span>Seguimientos Psicosociales</span>
            </div>
            <div class="tracking-followups__subtitle">Aquí encontrarás las fechas estimadas de tu próximo seguimiento con un profesional</div>

            <div class="tracking-followups__grid">
                <div class="follow-card follow-card--purple">
                    <div class="follow-card__icon"><img class="follow-card__icon-img" src="icons/Icon (50).svg" alt="" aria-hidden="true" /></div>
                    <div class="follow-card__content">
                        <div class="follow-card__k">Último seguimiento</div>
                        <div class="follow-card__v">
                            {{ followUp.lastSessionDate ?? 'Sin sesiones previas' }}
                        </div>
                    </div>
                    <div class="follow-card__hint follow-card__hint--full follow-card__hint--lift">
                        <ng-container *ngIf="followUp.lastSessionDaysAgo !== null; else noLastSession">
                            Tu última sesión con el profesional de salud mental fue hace
                            <b>{{ followUp.lastSessionDaysAgo }} {{ followUp.lastSessionDaysAgo === 1 ? 'día' : 'días' }}</b>
                        </ng-container>
                        <ng-template #noLastSession>Aún no tienes sesiones registradas.</ng-template>
                    </div>
                </div>

                <div class="follow-card follow-card--orange">
                    <div class="follow-card__icon"><img class="follow-card__icon-img" src="icons/Icon (52).svg" alt="" aria-hidden="true" /></div>
                    <div class="follow-card__content">
                        <div class="follow-card__k">Próximo seguimiento</div>
                        <div class="follow-card__v follow-card__v--orange">
                            {{ followUp.nextSessionDate ?? 'Sin programar' }}
                        </div>
                    </div>

                    <div class="follow-card__hint follow-card__hint--full">
                        <ng-container *ngIf="followUp.daysUntilNext !== null; else noNext">
                            Faltan <b>{{ followUp.daysUntilNext }} {{ followUp.daysUntilNext === 1 ? 'día' : 'días' }}</b> para tu próxima evaluación programada
                        </ng-container>
                        <ng-template #noNext>No tienes sesiones programadas próximamente.</ng-template>
                    </div>

                    <button class="follow-card__cta" mat-button (click)="scheduleFollowUp()">
                        <span class="follow-card__cta-content">
                            <img class="follow-card__cta-icon" src="icons/Icon (52).svg" alt="" aria-hidden="true" />
                            <span>Agendar Cita</span>
                        </span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Detailed modules (only completed) -->
        @if (moduleDetailCards.length > 0) {
        <section class="tracking-detail-list">
            @for (card of moduleDetailCards; track card.moduleId) {
            <div class="tracking-detail" [ngClass]="'tracking-detail--' + card.moduleId">
                <div class="tracking-detail__head">
                    <div class="tracking-detail__title">
                        <img class="tracking-detail__module-icon" [src]="moduleIcon(card.moduleId)" alt="" aria-hidden="true" />
                        <span>{{ card.title }}</span>
                    </div>
                    <div class="tracking-detail__meta">Evaluación completada el {{ card.completedAtLabel }}</div>
                </div>

                <div class="tracking-detail__card">
                    <div class="tracking-detail__progress">
                        <div class="tracking-detail__progress-title">Progreso de Evaluación</div>
                        <div class="tracking-detail__progress-grid">
                            <div class="pd-item">
                                <div class="pd-item__value pd-item__value--module">{{ card.progress.answered }}</div>
                                <div class="pd-item__label">Preguntas respondidas</div>
                            </div>
                            <div class="pd-item">
                                <div class="pd-item__value">{{ card.progress.missing }}</div>
                                <div class="pd-item__label">Preguntas faltantes</div>
                            </div>
                            <div class="pd-item pd-item--right">
                                <div class="pd-item__value pd-item__value--green">{{ card.progress.progressPercent }}%
                                </div>
                                <div class="pd-item__label">Avance total</div>
                            </div>
                            <div class="pd-pill">{{ card.progress.completedLabel }}</div>
                        </div>
                    </div>

                    <div class="tracking-detail__section-title">
                        <mat-icon svgIcon="heroicons_outline:information-circle"></mat-icon>
                        <span>Hallazgos</span>
                    </div>

                    <div class="tracking-findings">
                        @for (f of card.findings; track f.label) {
                        <div class="finding-row" [ngClass]="'finding-row--' + f.tone">
                            <div class="finding-row__top">
                                <span class="finding-row__label">{{ f.label }}</span>
                                <span class="finding-row__badge">{{ f.badge }}</span>
                                <span class="finding-row__pct">{{ f.value }}%</span>
                            </div>
                            <div class="finding-row__bar">
                                <div class="finding-row__bar-fill" [style.width.%]="f.value"></div>
                            </div>
                        </div>
                        } @if ((card.findings ?? []).length === 0) {
                        <div class="tracking-empty">No hay hallazgos disponibles para este resultado.</div>
                        }
                    </div>

                    <div class="tracking-detail__section-title">
                        <mat-icon svgIcon="heroicons_outline:heart"></mat-icon>
                        <span>Recomendaciones</span>
                    </div>

                    <div class="tracking-recs">
                        @for (r of card.recommendations; track r) {
                        <div class="rec-item">
                            <span class="rec-item__dot"></span>
                            <span class="rec-item__text">{{ r }}</span>
                        </div>
                        } @if ((card.recommendations ?? []).length === 0) {
                        <div class="tracking-empty">No hay recomendaciones disponibles para este resultado.</div>
                        }
                    </div>
                </div>
            </div>
            }
        </section>
        }

        <!-- Personalized recommendations -->
        <section class="tracking-personal">
            <div class="tracking-personal__inner">
                <div class="tracking-personal__head">
                    <div class="tracking-personal__title">
                        <mat-icon svgIcon="heroicons_outline:heart"></mat-icon>
                        <span>Recomendaciones Personalizadas para Ti</span>
                    </div>
                    <div class="tracking-personal__subtitle">Basadas en tus resultados actuales</div>
                </div>

                <div class="tracking-personal__list">
                    @for (p of personalizedCards; track p.moduleId) {
                    <div class="personal-card" [ngClass]="'personal-card--' + p.moduleId">
                        <div class="personal-card__header">
                            <div class="personal-card__icon">
                                <img class="personal-card__icon-img" [src]="moduleIcon(p.moduleId)" alt="" aria-hidden="true" />
                            </div>
                            <div class="personal-card__title">{{ p.title }}</div>
                        </div>
                        <div class="personal-card__body">
                            <div class="personal-card__text">{{ p.text }}</div>
                            <button class="personal-card__btn" mat-button (click)="openPersonalizedAction(p.moduleId)">{{ p.buttonLabel }}</button>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </section>

        <div class="tracking-personal__footer">
            <button class="footer-btn footer-btn--teal" mat-button (click)="exportReport()">
                <span class="footer-btn__content">
                    <mat-icon svgIcon="heroicons_outline:arrow-down-tray"></mat-icon>
                    <span class="footer-btn__text">Descargar Mi Reporte</span>
                </span>
            </button>
            <button class="footer-btn footer-btn--lime" mat-button (click)="scheduleFollowUp()">
                <span class="footer-btn__content">
                    <mat-icon svgIcon="heroicons_outline:calendar"></mat-icon>
                    <span class="footer-btn__text">Agendar Seguimiento</span>
                </span>
            </button>
            <button class="footer-btn footer-btn--blue" mat-button (click)="contactSupport()">
                <span class="footer-btn__content">
                    <mat-icon svgIcon="heroicons_outline:heart"></mat-icon>
                    <span class="footer-btn__text">Contactar Apoyo Profesional</span>
                </span>
            </button>
        </div>
    </div>
</div>